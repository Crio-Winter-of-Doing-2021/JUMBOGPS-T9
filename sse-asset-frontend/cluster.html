<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Create and style clusters</title>
    <meta
      name="viewport"
      content="initial-scale=1,maximum-scale=1,user-scalable=no"
    />

    <script src="https://api.mapbox.com/mapbox-gl-js/v2.2.0/mapbox-gl.js"></script>
    <link
      href="https://api.mapbox.com/mapbox-gl-js/v2.2.0/mapbox-gl.css"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/@turf/turf@5/turf.min.js"></script>

    <style>
      body {
        margin: 0;
        padding: 0;
      }
      #map {
        position: absolute;
        top: 0;
        bottom: 0;
        width: 100%;
      }
      .history {
        color: blue;
        text-decoration: underline;
        cursor: pointer;
      }
    </style>
    <style>
      #menu {
        background: #fff;
        position: absolute;
        z-index: 1;
        top: 10px;
        right: 10px;
        border-radius: 3px;
        width: 120px;
        border: 1px solid rgba(0, 0, 0, 0.4);
        font-family: "Open Sans", sans-serif;
      }

      #menu a {
        font-size: 13px;
        color: #404040;
        display: block;
        margin: 0;
        padding: 0;
        padding: 10px;
        text-decoration: none;
        border-bottom: 1px solid rgba(0, 0, 0, 0.25);
        text-align: center;
      }

      #menu a:last-child {
        border: none;
      }

      #menu a:hover {
        background-color: #f8f8f8;
        color: #404040;
      }

      #menu a.active {
        background-color: #3887be;
        color: #ffffff;
      }

      #menu a.active:hover {
        background: #3074a4;
      }
    </style>
  </head>
  <body>
    <nav id="menu"></nav>
    <div id="map"></div>

    <script>
      // add all the layers
      // keep them hidden
      // show data for assetView Layer
      //     call set data on the asset-data source
      //     call showLayer
      // show data for timelineView Layer
      //     hide assetView Layer
      //     call set data on the timeline-data source
      //     call showLayer
      let dummyGeoJson = {
        type: "FeatureCollection",
        features: [
          {
            type: "Feature",
            geometry: {
              type: "Point",
              coordinates: [-122.48369693756104, 37.83381888486939],
            },
          },
          {
            type: "Feature",
            geometry: {
              type: "Point",
              coordinates: [-122.48348236083984, 37.83317489144141],
            },
          },
          {
            type: "Feature",
            geometry: {
              type: "Point",
              coordinates: [-122.48339653015138, 37.83270036637107],
            },
          },
          {
            type: "Feature",
            geometry: {
              type: "Point",
              coordinates: [-122.48356819152832, 37.832056363179625],
            },
          },
          {
            type: "Feature",
            geometry: {
              type: "Point",
              coordinates: [-122.48404026031496, 37.83114119107971],
            },
          },
          {
            type: "Feature",
            geometry: {
              type: "Point",
              coordinates: [-122.48404026031496, 37.83049717427869],
            },
          },
          {
            type: "Feature",
            geometry: {
              type: "Point",
              coordinates: [-122.48348236083984, 37.829920943955045],
            },
          },
          {
            type: "Feature",
            geometry: {
              type: "Point",
              coordinates: [-122.48356819152832, 37.82954808664175],
            },
          },
          {
            type: "Feature",
            geometry: {
              type: "Point",
              coordinates: [-122.48507022857666, 37.82944639795659],
            },
          },
          {
            type: "Feature",
            geometry: {
              type: "Point",
              coordinates: [-122.48610019683838, 37.82880236636284],
            },
          },
        ],
      };

      let multipleGeometryJson = {
        type: "FeatureCollection",
        features: [
          {
            type: "Feature",
            geometry: {
              type: "Polygon",
              coordinates: [
                [
                  [-121.353637, 40.584978],
                  [-121.284551, 40.584758],
                  [-121.275349, 40.541646],
                  [-121.246768, 40.541017],
                  [-121.251343, 40.423383],
                  [-121.32687, 40.423768],
                  [-121.360619, 40.43479],
                  [-121.363694, 40.409124],
                  [-121.439713, 40.409197],
                  [-121.439711, 40.423791],
                  [-121.572133, 40.423548],
                  [-121.577415, 40.550766],
                  [-121.539486, 40.558107],
                  [-121.520284, 40.572459],
                  [-121.487219, 40.550822],
                  [-121.446951, 40.56319],
                  [-121.370644, 40.563267],
                  [-121.353637, 40.584978],
                ],
              ],
            },
          },
          {
            type: "Feature",
            geometry: {
              type: "Point",
              coordinates: [-121.415061, 40.506229],
            },
          },
          {
            type: "Feature",
            geometry: {
              type: "Point",
              coordinates: [-121.505184, 40.488084],
            },
          },
          {
            type: "Feature",
            geometry: {
              type: "Point",
              coordinates: [-121.354465, 40.488737],
            },
          },
        ],
      };

      let assetViewGeoJson = {
        type: "geojson",
        data: {
          type: "FeatureCollection",
          features: [
            {
              type: "Feature",
              properties: {
                description:
                  "<strong>Make it Mount Pleasant</strong><p>Make it Mount Pleasant is a handmade and vintage market and afternoon of live entertainment and kids activities. 12:00-6:00 p.m.</p>",
              },
              geometry: {
                type: "Point",
                coordinates: [-77.038659, 38.931567],
              },
            },
            {
              type: "Feature",
              properties: {
                description:
                  "<strong>Mad Men Season Five Finale Watch Party</strong><p>Head to Lounge 201 (201 Massachusetts Avenue NE) Sunday for a Mad Men Season Five Finale Watch Party, complete with 60s costume contest, Mad Men trivia, and retro food and drink. 8:00-11:00 p.m. $10 general admission, $20 admission and two hour open bar.</p>",
              },
              geometry: {
                type: "Point",
                coordinates: [-77.003168, 38.894651],
              },
            },
            {
              type: "Feature",
              properties: {
                description:
                  "<strong>Big Backyard Beach Bash and Wine Fest</strong><p>EatBar (2761 Washington Boulevard Arlington VA) is throwing a Big Backyard Beach Bash and Wine Fest on Saturday, serving up conch fritters, fish tacos and crab sliders, and Red Apron hot dogs. 12:00-3:00 p.m. $25.</p>",
              },
              geometry: {
                type: "Point",
                coordinates: [-77.090372, 38.881189],
              },
            },
            {
              type: "Feature",
              properties: {
                description:
                  "<strong>Ballston Arts & Crafts Market</strong><p>The Ballston Arts & Crafts Market sets up shop next to the Ballston metro this Saturday for the first of five dates this summer. Nearly 35 artists and crafters will be on hand selling their wares. 10:00-4:00 p.m.</p>",
              },
              geometry: {
                type: "Point",
                coordinates: [-77.111561, 38.882342],
              },
            },
            {
              type: "Feature",
              properties: {
                description:
                  "<strong>Seersucker Bike Ride and Social</strong><p>Feeling dandy? Get fancy, grab your bike, and take part in this year's Seersucker Social bike ride from Dandies and Quaintrelles. After the ride enjoy a lawn party at Hillwood with jazz, cocktails, paper hat-making, and more. 11:00-7:00 p.m.</p>",
              },
              geometry: {
                type: "Point",
                coordinates: [-77.052477, 38.943951],
              },
            },
            {
              type: "Feature",
              properties: {
                description:
                  "<strong>Capital Pride Parade</strong><p>The annual Capital Pride Parade makes its way through Dupont this Saturday. 4:30 p.m. Free.</p>",
              },
              geometry: {
                type: "Point",
                coordinates: [-77.043444, 38.909664],
              },
            },
            {
              type: "Feature",
              properties: {
                description:
                  "<strong>Muhsinah</strong><p>Jazz-influenced hip hop artist Muhsinah plays the Black Cat (1811 14th Street NW) tonight with Exit Clov and Godsâ€™illa. 9:00 p.m. $12.</p>",
              },
              geometry: {
                type: "Point",
                coordinates: [-77.031706, 38.914581],
              },
            },
            {
              type: "Feature",
              properties: {
                description:
                  "<strong>A Little Night Music</strong><p>The Arlington Players' production of Stephen Sondheim's <em>A Little Night Music</em> comes to the Kogod Cradle at The Mead Center for American Theater (1101 6th Street SW) this weekend and next. 8:00 p.m.</p>",
              },
              geometry: {
                type: "Point",
                coordinates: [-77.020945, 38.878241],
              },
            },
            {
              type: "Feature",
              properties: {
                description:
                  "<strong>Truckeroo</strong><p>Truckeroo brings dozens of food trucks, live music, and games to half and M Street SE (across from Navy Yard Metro Station) today from 11:00 a.m. to 11:00 p.m.</p>",
              },
              geometry: {
                type: "Point",
                coordinates: [-77.007481, 38.876516],
              },
            },
          ],
        },
      };

      const defaultCentroid = [0, 0];
      const defaultGeoJsonForAssetView = {
        type: "FeatureCollection",
        features: {
          type: "Feature",
          properties: {},
          geometry: {
            type: "Point",
            coordinates: [0, 0],
          },
        },
      };
      const defaultLineString = {
        type: "Feature",
        properties: {},
        geometry: {
          type: "LineString",
          coordinates: [],
        },
      };
      const defaultGeoJsonTimelineView = {
        type: "FeatureCollection",
        features: [
          {
            type: "Feature",
            geometry: {
              type: "Polygon",
              coordinates: [[]],
            },
          },
          {
            type: "Feature",
            geometry: {
              type: "Point",
              coordinates: [],
            },
          },
          {
            type: "Feature",
            properties: {},
            geometry: {
              type: "LineString",
              coordinates: [],
            },
          },
        ],
      };
      const assetViewLayers = [
        "clusters",
        "cluster-count",
        "unclustered-point",
      ];
      const timelineViewLayers = [
        "timeline-view-point",
        "timeline-view-polygon",
        "timeline-view-linestring-route",
        "route-line-string-view",
      ];
      const heatmapLayers = [
        "unclustered-point",
        "asset-view-heat-map",
        "asset-view-heat-map-point",
      ];
      const defaultClusterRadius = 50;

      mapboxgl.accessToken =
        "pk.eyJ1IjoiYW51Z3JhaHNpbmdoYWwiLCJhIjoiY2tscW1mcjcwMWVjaDJ2bjFmYml5cmNpNSJ9.1M6Wd3NEDq95YhoCyMxU8A";
      let map = new mapboxgl.Map({
        container: "map",
        // style: "mapbox://styles/mapbox/dark-v10",
        style: "mapbox://styles/mapbox/streets-v11",
        center: [0, 0],
        zoom: 3,
      });

      map.addControl(new mapboxgl.NavigationControl(), "bottom-right");

      map.on("load", function () {
        addImages(map, [
          { url: "icons/truck.png", id: "truck" },
          { url: "icons/person.png", id: "salesperson" },
          { url: "icons/truck.png", id: "truck+salesperson" },
          { url: "icons/custom_marker.png", id: "custom-marker" },
        ]).then(() => {
          addSourceAndLayersForAssetView();
          addSourceAndLayersForTimelineView();
          addLayerForHeatmapView();

          // inspect a cluster on click
          map.on("click", "clusters", function (e) {
            var features = map.queryRenderedFeatures(e.point, {
              layers: ["clusters"],
            });
            var clusterId = features[0].properties.cluster_id;
            map
              .getSource("asset-tracking-data")
              .getClusterExpansionZoom(clusterId, function (err, zoom) {
                if (err) return;

                map.easeTo({
                  center: features[0].geometry.coordinates,
                  zoom: zoom,
                });
              });
          });

          map.on("mouseenter", "clusters", function () {
            map.getCanvas().style.cursor = "pointer";
          });
          map.on("mouseleave", "clusters", function () {
            map.getCanvas().style.cursor = "";
          });

          var popup = new mapboxgl.Popup({});

          // When a click event occurs on a feature in
          // the unclustered-point layer, open a popup at
          // the location of the feature, with
          // description HTML from its properties.

          map.on("click", "unclustered-point", showPopup);
          map.on("click", "timeline-view-point", showPopup);

          map.on("mouseenter", "unclustered-point", showPopup);
          map.on("mouseenter", "timeline-view-point", showPopup);

          map.on("mouseleave", "unclustered-point", hideCursor);
          map.on("mouseleave", "timeline-view-point", hideCursor);

          function hideCursor() {
            map.getCanvas().style.cursor = "";
            // because we want to see the view persisted
            // popup.remove();
          }

          function showPopup(e) {
            map.getCanvas().style.cursor = "pointer";

            var coordinates = e.features[0].geometry.coordinates.slice();

            // Ensure that if the map is zoomed out such that
            // multiple copies of the feature are visible, the
            // popup appears over the copy being pointed to.
            while (Math.abs(e.lngLat.lng - coordinates[0]) > 180) {
              coordinates[0] += e.lngLat.lng > coordinates[0] ? 360 : -360;
            }

            let html = "";
            html = html + "<p>" + e.features[0].properties.id + "</p>";
            html =
              html +
              "<span><strong>Type:</strong>" +
              e.features[0].properties.title +
              "</span>";
            html = html + "<p>" + e.features[0].properties.type + "</p>";
            html =
              html +
              "<span>" +
              e.features[0].properties.description +
              "</span><br/>";
            html =
              html +
              "<span>" +
              e.features[0].properties.timestamp +
              "</span><br>";

            popup.setLngLat(coordinates).setHTML(html).addTo(map);
          }
        });
      });

      function getAssetDataAndRenderOnMap() {
        let geoJson;
        fetch("https://jumbogps-geo.anugrahsinghal.repl.co/assets?limit=100", {
          method: "GET", // *GET, POST, PUT, DELETE, etc.
          headers: {
            Authorization:
              "Bearer eyJhbGciOiJIUzUxMiJ9.eyJzdWIiOiJhbnUiLCJzY29wZXMiOlsiUk9MRV9BRE1JTiJdLCJpYXQiOjE2MTYwODcxNjYsImV4cCI6MTYxODA4NzE2Nn0.xTM2kH7HPx5GpoGbtpftOkg3iStjhSjkn77CPn5Q5LR3SjP5-4nbxRL4HPynEauInM49OvJlyvNAspyWy_FhgQ",
          },
        })
          .then((response) => {
            if (!response.ok) {
              throw Error(response.statusText);
            }
            response.json();
          })
          .then((data) => {
            console.log(data);

            let centroid = data.centroid;
            let assetAsFeatures = makeFeaturesFromAssets(data);

            let geoJson = {
              type: "FeatureCollection",
              features: assetAsFeatures,
            };

            showAssetView(geoJson);

            // renderMapForAssetViewData(centroid, geoJson);
          })
          .catch((err) => {
            console.log(err);
            alert(err.message);
          });
      }

      function getHistoryDataAndRenderOnMap(assetId) {}

      function makeFeaturesFromAssets(data) {
        let assets = data.assets;
        console.log(assets);
        let features = [];
        for (let i = 0; i < assets.length; i++) {
          features.push({
            type: "Feature",
            properties: {
              id: assets[i].id,
              title: assets[i].title,
              description: assets[i].description,
              assetType: assets[i].assetType,
              timestamp: assets[i].lastReportedTimestamp,
            },
            geometry: assets[i].lastReportedCoordinates,
          });
        }
        return features;
      }

      function showAssetView(geoJsonData) {
        hideLayers(timelineViewLayers);
        hideLayers(heatmapLayers);

        map.getSource("asset-tracking-data").setData(geoJsonData);

        map.fitBounds(turf.bbox(geoJsonData), { padding: 40 });

        showLayers(assetViewLayers);
      }

      function showTimeLineView(geoJsonData) {
        hideLayers(assetViewLayers);
        hideLayers(heatmapLayers);

        map.getSource("timeline-view").setData(geoJsonData);
        map
          .getSource("route-line-string")
          .setData(makeLineStringForGeoJsonTimelineView(geoJsonData));

        map.fitBounds(turf.bbox(geoJsonData), { padding: 40 });

        showLayers(timelineViewLayers);
      }

      function addSourceAndLayersForAssetView() {
        // Add a new source from our GeoJSON data and
        // set the 'cluster' option to true. GL-JS will
        // add the point_count property to your source data.
        /* THE SOURCE LAYER FOR ASSET TRACKING DATA */
        map.addSource("asset-tracking-data", {
          type: "geojson",
          // Point to GeoJSON data. This example visualizes all M1.0+ asset-tracking-data
          // from 12/22/15 to 1/21/16 as logged by USGS' Earthquake hazards program.
          data: defaultGeoJsonForAssetView,
          //   "https://docs.mapbox.com/mapbox-gl-js/assets/asset-tracking-data.geojson",
          cluster: true,
          clusterMaxZoom: 14, // Max zoom to cluster points on
          clusterRadius: defaultClusterRadius, // Radius of each cluster when clustering points (defaults to 50)
          clusterProperties: {
            has_truck: ["any", ["==", ["get", "assetType"], "truck"], "false"],
            has_salesperson: [
              "any",
              ["==", ["get", "assetType"], "salesperson"],
              "false",
            ],
            only_truck: ["all", ["==", ["get", "assetType"], "truck"], "false"],
            only_salesperson: [
              "all",
              ["==", ["get", "assetType"], "salesperson"],
              "false",
            ],
            truck: ["+", ["case", truck, 1, 0]],
            salesperson: ["+", ["case", salesperson, 1, 0]],
            others: ["+", ["case", others, 1, 0]],
          },
        });

        map.addLayer({
          id: "clusters",
          type: "circle",
          source: "asset-tracking-data",
          filter: ["has", "point_count"],
          // layout: {
          //   "icon-image": [
          //     "case",
          //     ["all", ["get", "has_truck"], ["get", "has_salesperson"]],
          //     "truck+salesperson",
          //     ["get", "only_truck"],
          //     "truck",
          //     "salesperson",
          //   ],
          //   "icon-size": 0.06,
          //   "icon-allow-overlap": true,
          // },
          paint: {
            // Use step expressions (https://docs.mapbox.com/mapbox-gl-js/style-spec/#expressions-step)
            // with three steps to implement three types of circles:
            //   * Blue, 20px circles when point count is less than 100
            //   * Yellow, 30px circles when point count is between 100 and 750
            //   * Pink, 40px circles when point count is greater than or equal to 750
            "circle-color": [
              "step",
              ["get", "point_count"],
              "#51bbd6",
              100,
              "#f1f075",
              750,
              "#f28cb1",
            ],
            "circle-radius": [
              "step",
              ["get", "point_count"],
              20,
              100,
              30,
              750,
              40,
            ],
          },
          layout: {
            visibility: "none",
          },
        });

        map.addLayer({
          id: "cluster-count",
          type: "symbol",
          source: "asset-tracking-data",
          filter: ["has", "point_count"],
          layout: {
            "text-field": "{point_count_abbreviated}",
            "text-font": ["DIN Offc Pro Medium", "Arial Unicode MS Bold"],
            "text-size": 12,
            visibility: "none",
          },
        });

        map.addLayer({
          id: "unclustered-point",
          type: "symbol",
          source: "asset-tracking-data",
          filter: ["!", ["has", "point_count"]],
          layout: {
            "icon-image": [
              "coalesce",
              ["image", "custom-marker"],
              ["image", "rocket-15"],
            ],
            "icon-allow-overlap": true,
            "icon-size": 0.6,
            visibility: "none",
          },
        });

        // map.addLayer({
        //       id: "custom-image-layer",
        //       type: "symbol",
        //       source: "asset-tracking-data",
        //       filter: ["!", ["has", "point_count"]],
        //       layout: {
        //         "icon-image": "custom-marker",
        //         "icon-allow-overlap": true,
        //         "icon-size": 0.6,
        //         visibility: "visible",
        //       },
        //     });
      }

      function addSourceAndLayersForTimelineView() {
        addSourceAndLayerForRoute();
        addSourceAndLayerForAssetTimeLineView();
      }

      function addSourceAndLayerForRoute() {
        map.addSource("route-line-string", {
          type: "geojson",
          data: defaultLineString,
          // data: makeLineStringForGeoJsonTimelineView(timelineViewGeoJsonData),
          // <!-- #region data other forms -->
          // data: turf.lineString(
          //   makeLineStringForGeoJsonTimelineView(timelineViewGeoJsonData)
          //     .geometry.coordinates
          // ),
          // data with linestring data

          /*
          data: {
                    type: "Feature",
                    properties: {},
                    geometry: {
                      type: "LineString",
                      coordinates: [
                        [-122.48369693756104, 37.83381888486939],
                        [-122.48348236083984, 37.83317489144141],
                        [-122.48339653015138, 37.83270036637107],
                        [-122.48356819152832, 37.832056363179625],
                        [-122.48404026031496, 37.83114119107971],
                        [-122.48404026031496, 37.83049717427869],
                        [-122.48348236083984, 37.829920943955045],
                        [-122.48356819152832, 37.82954808664175],
                        [-122.48507022857666, 37.82944639795659],
                        [-122.48610019683838, 37.82880236636284],
                        [-122.48695850372314, 37.82931081282506],
                        [-122.48700141906738, 37.83080223556934],
                        [-122.48751640319824, 37.83168351665737],
                        [-122.48803138732912, 37.832158048267786],
                        [-122.48888969421387, 37.83297152392784],
                        [-122.48987674713133, 37.83263257682617],
                        [-122.49043464660643, 37.832937629287755],
                        [-122.49125003814696, 37.832429207817725],
                        [-122.49163627624512, 37.832564787218985],
                        [-122.49223709106445, 37.83337825839438],
                        [-122.49378204345702, 37.83368330777276],
                      ],
                    },
                  },

          <!-- #endregion -->
          */
        });
        map.addLayer({
          id: "route-line-string-view",
          type: "line",
          source: "route-line-string",
          layout: {
            "line-join": "round",
            "line-cap": "round",
            visibility: "none",
          },
          paint: {
            "line-color": "#888",
            // "line-color": "#f28cb1",
            // "line-color": "red",
            "line-width": 8,
          },
        });
      }

      function addSourceAndLayerForAssetTimeLineView() {
        map.addSource("timeline-view", {
          type: "geojson",
          // data: timelineViewGeoJsonData,
          data: defaultGeoJsonTimelineView,
        });

        map.addLayer({
          id: "timeline-view-point",
          type: "symbol",
          source: "timeline-view",
          filter: ["==", "$type", "Point"],
          layout: {
            // "icon-image": "custom-marker",
            "icon-image": [
              "coalesce",
              ["image", "custom-marker"],
              ["image", "rocket-15"],
            ],
            "icon-allow-overlap": true,
            "icon-size": 0.5,
            visibility: "none",
          },
        });

        map.addLayer({
          id: "timeline-view-polygon",
          type: "fill",
          source: "timeline-view",
          paint: {
            "fill-color": "#888888",
            "fill-opacity": 0.3,
          },
          filter: ["==", "$type", "Polygon"],
          layout: {
            visibility: "none",
          },
        });

        map.addLayer({
          id: "timeline-view-linestring-route",
          type: "line",
          source: "timeline-view",
          layout: {
            "line-join": "round",
            "line-cap": "round",
            visibility: "none",
          },
          paint: {
            "line-color": "#f28cb1",
            "line-width": 8,
          },
          filter: ["==", "$type", "LineString"],
        });
      }

      function addImages(map, images) {
        const addImage = (map, id, url) => {
          return new Promise((resolve, reject) => {
            map.loadImage(url, (error, image) => {
              if (error) {
                reject(error);
                return;
              }
              map.addImage(id, image);
              resolve(image);
            });
          });
        };
        const promises = images.map((imageData) =>
          addImage(map, imageData.id, imageData.url)
        );
        return Promise.all(promises);
      }

      function hideLayers(layerNames) {
        if (layerNames !== undefined && layerNames.length > 0) {
          for (let i = 0; i < layerNames.length; i++) {
            let clickedLayer = layerNames[i];
            let visibility = map.getLayoutProperty(clickedLayer, "visibility");

            // Toggle layer visibility by changing the layout object's visibility property.
            if (visibility !== undefined && visibility === "visible") {
              map.setLayoutProperty(clickedLayer, "visibility", "none");
            }
          }
        }
      }

      function showLayers(layerNames) {
        if (layerNames !== undefined && layerNames.length > 0) {
          for (let i = 0; i < layerNames.length; i++) {
            let clickedLayer = layerNames[i];
            let visibility = map.getLayoutProperty(clickedLayer, "visibility");

            // Toggle layer visibility by changing the layout object's visibility property.
            if (visibility !== undefined && visibility === "none") {
              map.setLayoutProperty(clickedLayer, "visibility", "visible");
            }
          }
        }
      }

      function showThePopup(e) {
        map.getCanvas().style.cursor = "pointer";

        var coordinates = e.features[0].geometry.coordinates.slice();

        // Ensure that if the map is zoomed out such that
        // multiple copies of the feature are visible, the
        // popup appears over the copy being pointed to.
        while (Math.abs(e.lngLat.lng - coordinates[0]) > 180) {
          coordinates[0] += e.lngLat.lng > coordinates[0] ? 360 : -360;
        }

        let html = "";
        html = html + "<p>" + e.features[0].properties.id + "</p>";
        html =
          html +
          "<span><strong>Type:</strong>" +
          e.features[0].properties.title +
          "</span>";
        html = html + "<p>" + e.features[0].properties.type + "</p>";
        html =
          html +
          "<span>" +
          e.features[0].properties.description +
          "</span><br/>";
        html =
          html + "<span>" + e.features[0].properties.timestamp + "</span><br>";

        new mapboxgl.Popup({ closeOnMove: true })
          .setLngLat(coordinates)
          .setHTML(html)
          .addTo(map);
      }

      function makeLineStringForGeoJsonTimelineView(timelineViewGeoJsonData) {
        let features = timelineViewGeoJsonData.features;
        let lineStringCoordinates = [];
        for (let i = 0; i < features.length; i++) {
          if (features[i].geometry.type == "Point") {
            lineStringCoordinates.push(features[i].geometry.coordinates);
          }
        }
        let lineString = {
          type: "Feature",
          properties: {},
          geometry: {
            type: "LineString",
            coordinates: [lineStringCoordinates],
          },
        };
        return lineString;
      }

      map.on("idle", function () {
        // If these two layers have been added to the style,
        // add the toggle buttons.
        // Enumerate ids of the layers.
        var toggleableLayerIds = [
          "asset-view",
          "timeline-view",
          "timeline-view-with-polygon",
          "heatmap-layer",
        ];
        // Set up the corresponding toggle button for each layer.
        for (var i = 0; i < toggleableLayerIds.length; i++) {
          var id = toggleableLayerIds[i];
          // Create a link.
          if (!document.getElementById(id)) {
            var link = document.createElement("a");
            link.id = id;
            link.href = "#";
            link.textContent = id;
            link.className = "active";
            // Show or hide layer when the toggle is clicked.
            link.onclick = function (e) {
              var clickedLayer = this.textContent;
              e.preventDefault();
              e.stopPropagation();

              if (clickedLayer === "asset-view") {
                showAssetView(assetViewGeoJson);
              } else if (clickedLayer === "timeline-view-with-polygon") {
                showTimeLineView(multipleGeometryJson);
              } else if (clickedLayer === "timeline-view") {
                showTimeLineView(dummyGeoJson);
              } else if (clickedLayer === "heatmap-layer") {
                map.getSource("asset-tracking-data").setData(dummyGeoJson);
                map.fitBounds(turf.bbox(dummyGeoJson), {
                  padding: 40,
                  maxZoom: 7,
                });
                hideLayers(assetViewLayers);
                hideLayers(timelineViewLayers);
                showLayers(heatmapLayers);
              }
            };

            var layers = document.getElementById("menu");
            layers.appendChild(link);
          }
        }
      });

      function addLayerForHeatmapView() {
        map.addLayer(
          {
            id: "asset-view-heat-map",
            type: "heatmap",
            source: "asset-tracking-data",
            maxzoom: 9,
            paint: {
              // Increase the heatmap weight based on frequency and property magnitude
              "heatmap-weight": [
                "interpolate",
                ["linear"],
                ["get", "mag"],
                0,
                0,
                6,
                1,
              ],
              // Increase the heatmap color weight weight by zoom level
              // heatmap-intensity is a multiplier on top of heatmap-weight
              "heatmap-intensity": [
                "interpolate",
                ["linear"],
                ["zoom"],
                0,
                1,
                9,
                3,
              ],
              // Color ramp for heatmap.  Domain is 0 (low) to 1 (high).
              // Begin color ramp at 0-stop with a 0-transparancy color
              // to create a blur-like effect.
              "heatmap-color": [
                "interpolate",
                ["linear"],
                ["heatmap-density"],
                0,
                "rgba(33,102,172,0)",
                0.2,
                "rgb(103,169,207)",
                0.4,
                "rgb(209,229,240)",
                0.6,
                "rgb(253,219,199)",
                0.8,
                "rgb(239,138,98)",
                1,
                "rgb(178,24,43)",
              ],
              // Adjust the heatmap radius by zoom level
              "heatmap-radius": [
                "interpolate",
                ["linear"],
                ["zoom"],
                0,
                2,
                9,
                20,
              ],
              // Transition from heatmap to circle layer by zoom level
              "heatmap-opacity": [
                "interpolate",
                ["linear"],
                ["zoom"],
                7,
                1,
                9,
                0,
              ],
            },
            layout: {
              visibility: "none",
            },
          },
          // add layer before given layer
          "waterway-label"
        );

        map.addLayer(
          {
            id: "asset-view-heat-map-point",
            type: "circle",
            source: "asset-tracking-data",
            minzoom: 7,
            paint: {
              // Size circle radius by earthquake magnitude and zoom level
              "circle-radius": [
                "interpolate",
                ["linear"],
                ["zoom"],
                7,
                ["interpolate", ["linear"], ["get", "mag"], 1, 1, 6, 4],
                16,
                ["interpolate", ["linear"], ["get", "mag"], 1, 5, 6, 50],
              ],
              // Color circle by earthquake magnitude
              "circle-color": [
                "interpolate",
                ["linear"],
                ["get", "mag"],
                1,
                "rgba(33,102,172,0)",
                2,
                "rgb(103,169,207)",
                3,
                "rgb(209,229,240)",
                4,
                "rgb(253,219,199)",
                5,
                "rgb(239,138,98)",
                6,
                "rgb(178,24,43)",
              ],
              "circle-stroke-color": "white",
              "circle-stroke-width": 1,
              // Transition from heatmap to circle layer by zoom level
              "circle-opacity": [
                "interpolate",
                ["linear"],
                ["zoom"],
                7,
                0,
                8,
                1,
              ],
            },
            layout: {
              visibility: "none",
            },
          },
          "waterway-label"
        );
      }
    </script>

    <script>
      // old code

      const salesperson = ["==", ["get", "assetType"], "SALESPERSON"];
      const truck = ["==", ["get", "assetType"], "TRUCK"];
      const others = [
        "any",
        ["==", ["get", "assetType"], "Cogeneration"],
        ["==", ["get", "assetType"], ""],
      ];

      function showtimelineViewForAsset(timelineViewGeoJsonData) {
        makeLineLayerOnMap(timelineViewGeoJsonData);
      }

      function renderMapForAssetViewData(centroid, geoJsonData) {
        console.log(geoJsonData);
        // for recentering the map to a marker
        map.flyTo({
          center: centroid.coordinates,
          essential: true, // this animation is considered essential with respect to prefers-reduced-motion
          zoom: 1,
          bearing: 0,

          // These options control the flight curve, making it move
          // slowly and zoom out almost completely before starting
          // to pan.
          speed: 0.2, // make the flying slow
          curve: 1, // change the speed at which it zooms out
        });
      }

      function makeLineLayerOnMap(timelineViewGeoJsonData) {
        map.addSource("route-line-string", {
          type: "geojson",
          data: defaultLineString,
          // data: makeLineStringForGeoJsonTimelineView(timelineViewGeoJsonData),
          // <!-- #region data other forms -->
          // data: turf.lineString(
          //   makeLineStringForGeoJsonTimelineView(timelineViewGeoJsonData)
          //     .geometry.coordinates
          // ),
          // data with linestring data

          /*
          data: {
                    type: "Feature",
                    properties: {},
                    geometry: {
                      type: "LineString",
                      coordinates: [
                        [-122.48369693756104, 37.83381888486939],
                        [-122.48348236083984, 37.83317489144141],
                        [-122.48339653015138, 37.83270036637107],
                        [-122.48356819152832, 37.832056363179625],
                        [-122.48404026031496, 37.83114119107971],
                        [-122.48404026031496, 37.83049717427869],
                        [-122.48348236083984, 37.829920943955045],
                        [-122.48356819152832, 37.82954808664175],
                        [-122.48507022857666, 37.82944639795659],
                        [-122.48610019683838, 37.82880236636284],
                        [-122.48695850372314, 37.82931081282506],
                        [-122.48700141906738, 37.83080223556934],
                        [-122.48751640319824, 37.83168351665737],
                        [-122.48803138732912, 37.832158048267786],
                        [-122.48888969421387, 37.83297152392784],
                        [-122.48987674713133, 37.83263257682617],
                        [-122.49043464660643, 37.832937629287755],
                        [-122.49125003814696, 37.832429207817725],
                        [-122.49163627624512, 37.832564787218985],
                        [-122.49223709106445, 37.83337825839438],
                        [-122.49378204345702, 37.83368330777276],
                      ],
                    },
                  },

          <!-- #endregion -->
          */
        });
        map.addLayer({
          id: "route-line-string-view",
          type: "line",
          source: "route-line-string",
          layout: {
            "line-join": "round",
            "line-cap": "round",
            visibility: "none",
          },
          paint: {
            "line-color": "#888",
            // "line-color": "#f28cb1",
            // "line-color": "red",
            "line-width": 8,
          },
        });

        map.addSource("timeline-view", {
          type: "geojson",
          // data: timelineViewGeoJsonData,
          data: defaultGeoJsonTimelineView,
        });

        map.addLayer({
          id: "timeline-view-point",
          type: "symbol",
          source: "timeline-view",
          filter: ["==", "$type", "Point"],
          layout: {
            // "icon-image": "custom-marker",
            "icon-image": [
              "coalesce",
              ["image", "custom-marker"],
              ["image", "rocket-15"],
            ],
            "icon-allow-overlap": true,
            "icon-size": 0.5,
            visibility: "none",
          },
        });

        map.addLayer({
          id: "timeline-view-polygon",
          type: "fill",
          source: "timeline-view",
          paint: {
            "fill-color": "#888888",
            "fill-opacity": 0.3,
          },
          filter: ["==", "$type", "Polygon"],
          layout: {
            visibility: "none",
          },
        });

        map.addLayer({
          id: "timeline-view-linestring-route",
          type: "line",
          source: "timeline-view",
          layout: {
            "line-join": "round",
            "line-cap": "round",
            visibility: "none",
          },
          paint: {
            "line-color": "#f28cb1",
            "line-width": 8,
          },
          filter: ["==", "$type", "LineString"],
        });

        hideLayers(assetViewLayers);
        showLayers(timelineViewLayers);
        /* <!-- #region flyto -->

        map.flyTo({
          center: getCenterForTimeLineView(timelineViewGeoJsonData),
          essential: true, // this animation is considered essential with respect to prefers-reduced-motion
          zoom: 14,
          bearing: 0,

          // These options control the flight curve, making it move
          // slowly and zoom out almost completely before starting
          // to pan.
          speed: 0.8, // make the flying slow
          curve: 1, // change the speed at which it zooms out
        });

        <!-- #endregion --> */

        // map.fitBounds(turf.bbox(timelineViewGeoJsonData), { padding: 20 });
      }

      function createLayerFilterOnIdleMap() {
        map.on("idle", function () {
          // If these two layers have been added to the style,
          // add the toggle buttons.
          if (map.getLayer("clusters") && map.getLayer("unclustered-point")) {
            // Enumerate ids of the layers.
            var toggleableLayerIds = ["clusters", "unclustered-point"];
            // Set up the corresponding toggle button for each layer.
            for (var i = 0; i < toggleableLayerIds.length; i++) {
              var id = toggleableLayerIds[i];
              if (!document.getElementById(id)) {
                // Create a link.
                var link = document.createElement("a");
                link.id = id;
                link.href = "#";
                link.textContent = id;
                link.className = "active";
                // Show or hide layer when the toggle is clicked.
                link.onclick = function (e) {
                  var clickedLayer = this.textContent;
                  e.preventDefault();
                  e.stopPropagation();

                  var visibility = map.getLayoutProperty(
                    clickedLayer,
                    "visibility"
                  );

                  // Toggle layer visibility by changing the layout object's visibility property.
                  if (visibility === "visible") {
                    map.setLayoutProperty(clickedLayer, "visibility", "none");
                    this.className = "";
                  } else {
                    this.className = "active";
                    map.setLayoutProperty(
                      clickedLayer,
                      "visibility",
                      "visible"
                    );
                  }
                };

                var layers = document.getElementById("menu");
                layers.appendChild(link);
              }
            }
          }
        });
      } /* } function end*/

      function getCenterForTimeLineView(timelineViewGeoJsonData) {
        let len = timelineViewGeoJsonData.features.length;
        let mid = Math.floor(len / 2);
        return timelineViewGeoJsonData.features[mid].geometry.coordinates;
      }
    </script>
  </body>
</html>
