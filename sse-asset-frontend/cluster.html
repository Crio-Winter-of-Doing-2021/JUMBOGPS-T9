<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Create and style clusters</title>
    <meta
      name="viewport"
      content="initial-scale=1,maximum-scale=1,user-scalable=no"
    />

    <script src="https://api.mapbox.com/mapbox-gl-js/v2.2.0/mapbox-gl.js"></script>
    <link
      href="https://api.mapbox.com/mapbox-gl-js/v2.2.0/mapbox-gl.css"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/@turf/turf@5/turf.min.js"></script>

    <style>
      body {
        margin: 0;
        padding: 0;
      }
      #map {
        position: absolute;
        top: 0;
        bottom: 0;
        width: 100%;
      }
      .history {
        color: blue;
        text-decoration: underline;
        cursor: pointer;
      }
    </style>
    <style>
      #menu {
        background: #fff;
        position: absolute;
        z-index: 1;
        top: 10px;
        right: 10px;
        border-radius: 3px;
        width: 120px;
        border: 1px solid rgba(0, 0, 0, 0.4);
        font-family: "Open Sans", sans-serif;
      }

      #menu a {
        font-size: 13px;
        color: #404040;
        display: block;
        margin: 0;
        padding: 0;
        padding: 10px;
        text-decoration: none;
        border-bottom: 1px solid rgba(0, 0, 0, 0.25);
        text-align: center;
      }

      #menu a:last-child {
        border: none;
      }

      #menu a:hover {
        background-color: #f8f8f8;
        color: #404040;
      }

      #menu a.active {
        background-color: #3887be;
        color: #ffffff;
      }

      #menu a.active:hover {
        background: #3074a4;
      }
    </style>
  </head>
  <body>
    <nav id="menu"></nav>
    <div id="map"></div>

    <script>
      // add all the layers
      // keep them hidden
      // show data for assetView Layer
      //     call set data on the asset-data source
      //     call showLayer
      // show data for timelineView Layer
      //     hide assetView Layer
      //     call set data on the timeline-data source
      //     call showLayer
      const salesperson = ["==", ["get", "assetType"], "SALESPERSON"];
      const truck = ["==", ["get", "assetType"], "TRUCK"];
      const others = [
        "any",
        ["==", ["get", "assetType"], "Cogeneration"],
        ["==", ["get", "assetType"], ""],
      ];

      let dummyGeoJson = {
        type: "FeatureCollection",
        features: [
          {
            type: "Feature",
            geometry: {
              type: "Point",
              coordinates: [-122.48369693756104, 37.83381888486939],
            },
          },
          {
            type: "Feature",
            geometry: {
              type: "Point",
              coordinates: [-122.48348236083984, 37.83317489144141],
            },
          },
          {
            type: "Feature",
            geometry: {
              type: "Point",
              coordinates: [-122.48339653015138, 37.83270036637107],
            },
          },
          {
            type: "Feature",
            geometry: {
              type: "Point",
              coordinates: [-122.48356819152832, 37.832056363179625],
            },
          },
          {
            type: "Feature",
            geometry: {
              type: "Point",
              coordinates: [-122.48404026031496, 37.83114119107971],
            },
          },
          {
            type: "Feature",
            geometry: {
              type: "Point",
              coordinates: [-122.48404026031496, 37.83049717427869],
            },
          },
          {
            type: "Feature",
            geometry: {
              type: "Point",
              coordinates: [-122.48348236083984, 37.829920943955045],
            },
          },
          {
            type: "Feature",
            geometry: {
              type: "Point",
              coordinates: [-122.48356819152832, 37.82954808664175],
            },
          },
          {
            type: "Feature",
            geometry: {
              type: "Point",
              coordinates: [-122.48507022857666, 37.82944639795659],
            },
          },
          {
            type: "Feature",
            geometry: {
              type: "Point",
              coordinates: [-122.48610019683838, 37.82880236636284],
            },
          },
        ],
      };

      let multipleGeometryJson = {
        type: "FeatureCollection",
        features: [
          {
            type: "Feature",
            geometry: {
              type: "Polygon",
              coordinates: [
                [
                  [-121.353637, 40.584978],
                  [-121.284551, 40.584758],
                  [-121.275349, 40.541646],
                  [-121.246768, 40.541017],
                  [-121.251343, 40.423383],
                  [-121.32687, 40.423768],
                  [-121.360619, 40.43479],
                  [-121.363694, 40.409124],
                  [-121.439713, 40.409197],
                  [-121.439711, 40.423791],
                  [-121.572133, 40.423548],
                  [-121.577415, 40.550766],
                  [-121.539486, 40.558107],
                  [-121.520284, 40.572459],
                  [-121.487219, 40.550822],
                  [-121.446951, 40.56319],
                  [-121.370644, 40.563267],
                  [-121.353637, 40.584978],
                ],
              ],
            },
          },
          {
            type: "Feature",
            geometry: {
              type: "Point",
              coordinates: [-121.415061, 40.506229],
            },
          },
          {
            type: "Feature",
            geometry: {
              type: "Point",
              coordinates: [-121.505184, 40.488084],
            },
          },
          {
            type: "Feature",
            geometry: {
              type: "Point",
              coordinates: [-121.354465, 40.488737],
            },
          },
        ],
      };

      mapboxgl.accessToken =
        "pk.eyJ1IjoiYW51Z3JhaHNpbmdoYWwiLCJhIjoiY2tscW1mcjcwMWVjaDJ2bjFmYml5cmNpNSJ9.1M6Wd3NEDq95YhoCyMxU8A";
      let map = new mapboxgl.Map({
        container: "map",
        // style: "mapbox://styles/mapbox/dark-v10",
        style: "mapbox://styles/mapbox/streets-v11",
        center: [0, 0],
        zoom: 3,
      });

      const defaultCentroid = [0, 0];
      const defaultGeoJsonForAssetView = {
        type: "FeatureCollection",
        features: {
          type: "Feature",
          properties: {},
          geometry: {
            type: "Point",
            coordinates: [0, 0],
          },
        },
      };
      const defaultLineString = {
        type: "Feature",
        properties: {},
        geometry: {
          type: "LineString",
          coordinates: [],
        },
      };
      const defaultGeoJsonTimelineView = {
        type: "FeatureCollection",
        features: [
          {
            type: "Feature",
            geometry: {
              type: "Polygon",
              coordinates: [[]],
            },
          },
          {
            type: "Feature",
            geometry: {
              type: "Point",
              coordinates: [],
            },
          },
          {
            type: "Feature",
            properties: {},
            geometry: {
              type: "LineString",
              coordinates: [],
            },
          },
        ],
      };
      const assetViewLayers = [
        "clusters",
        "cluster-count",
        "unclustered-point",
      ];
      const timelineViewLayers = [
        "timeline-view-point",
        "timeline-view-polygon",
        "timeline-view-linestring-route",
        "route-line-string-view",
      ];
      const defaultClusterRadius = 50;

      map.addControl(new mapboxgl.NavigationControl());

      // getDataAndRenderOnMap();

      function getDataAndRenderOnMap() {
        let geoJson;
        fetch("https://jumbogps-geo.anugrahsinghal.repl.co/assets?limit=100", {
          method: "GET", // *GET, POST, PUT, DELETE, etc.
          headers: {
            Authorization:
              "Bearer eyJhbGciOiJIUzUxMiJ9.eyJzdWIiOiJhbnUiLCJzY29wZXMiOlsiUk9MRV9BRE1JTiJdLCJpYXQiOjE2MTYwODcxNjYsImV4cCI6MTYxODA4NzE2Nn0.xTM2kH7HPx5GpoGbtpftOkg3iStjhSjkn77CPn5Q5LR3SjP5-4nbxRL4HPynEauInM49OvJlyvNAspyWy_FhgQ",
          },
        })
          .then((response) => response.json())
          .then((data) => {
            console.log(data);

            let centroid = data.centroid;
            let assetAsFeatures = getAllFeaturesFromAssets(data);

            let geoJson = {
              type: "FeatureCollection",
              features: assetAsFeatures,
            };

            renderMapForAssetViewData(centroid, geoJson);
          })
          .catch((err) => {
            console.log(err);
            renderMapForAssetViewData(
              defaultCentroid,
              defaultGeoJsonForAssetView
            );
            alert("Asset Data Not Found");
          });
      }

      function getAllFeaturesFromAssets(data) {
        let assets = data.assets;
        console.log(assets);
        let features = [];
        for (let i = 0; i < assets.length; i++) {
          features.push({
            type: "Feature",
            properties: {
              id: assets[i].id,
              title: assets[i].title,
              description: assets[i].description,
              assetType: assets[i].assetType,
              timestamp: assets[i].lastReportedTimestamp,
            },
            geometry: assets[i].lastReportedCoordinates,
          });
        }
        return features;
      }

      function renderMapForAssetViewData(centroid, geoJsonData) {
        console.log(geoJsonData);
        // for recentering the map to a marker
        map.flyTo({
          center: centroid.coordinates,
          essential: true, // this animation is considered essential with respect to prefers-reduced-motion
          zoom: 1,
          bearing: 0,

          // These options control the flight curve, making it move
          // slowly and zoom out almost completely before starting
          // to pan.
          speed: 0.2, // make the flying slow
          curve: 1, // change the speed at which it zooms out
        });
      }

      function showAssetView(geoJsonData) {
        hideLayers(timelineViewLayers);

        map.getSource("asset-tracking-data").setData(geoJsonData);

        map.fitBounds(turf.bbox(geoJsonData), { padding: 20 });

        showLayers(assetViewLayers);
      }

      function showTimeLineView(geoJsonData) {
        hideLayers(assetViewLayers);

        map.getSource("timeline-view").setData(geoJsonData);
        map
          .getSource("route-line-string")
          .setData(makeLineStringForGeoJsonTimelineView(geoJsonData));

        map.fitBounds(turf.bbox(geoJsonData), { padding: 20 });

        showLayers(timelineViewLayers);
      }

      map.on("load", function () {
        addImages(map, [
          { url: "icons/truck.png", id: "truck" },
          { url: "icons/person.png", id: "salesperson" },
          { url: "icons/truck.png", id: "truck+salesperson" },
          { url: "icons/custom_marker.png", id: "custom-marker" },
        ]).then(() => {
          addSourceAndLayersForAssetView();
          addSourceAndLayersForTimelineView();

          // inspect a cluster on click
          map.on("click", "clusters", function (e) {
            var features = map.queryRenderedFeatures(e.point, {
              layers: ["clusters"],
            });
            var clusterId = features[0].properties.cluster_id;
            map
              .getSource("asset-tracking-data")
              .getClusterExpansionZoom(clusterId, function (err, zoom) {
                if (err) return;

                map.easeTo({
                  center: features[0].geometry.coordinates,
                  zoom: zoom,
                });
              });
          });

          // When a click event occurs on a feature in
          // the unclustered-point layer, open a popup at
          // the location of the feature, with
          // description HTML from its properties.
          map.on("click", "unclustered-point", showThePopup);

          map.on("mouseenter", "clusters", function () {
            map.getCanvas().style.cursor = "pointer";
          });
          map.on("mouseleave", "clusters", function () {
            map.getCanvas().style.cursor = "";
          });
          map.on("mouseenter", "unclustered-point", showThePopup);
          map.on("mouseleave", "unclustered-point", function () {
            map.getCanvas().style.cursor = "";
          });
        });
      });

      function showThePopup(e) {
        map.getCanvas().style.cursor = "pointer";

        var coordinates = e.features[0].geometry.coordinates.slice();

        // Ensure that if the map is zoomed out such that
        // multiple copies of the feature are visible, the
        // popup appears over the copy being pointed to.
        while (Math.abs(e.lngLat.lng - coordinates[0]) > 180) {
          coordinates[0] += e.lngLat.lng > coordinates[0] ? 360 : -360;
        }

        let html = "";
        html = html + "<p>" + e.features[0].properties.id + "</p>";
        html =
          html +
          "<span><strong>Type:</strong>" +
          e.features[0].properties.title +
          "</span>";
        html = html + "<p>" + e.features[0].properties.type + "</p>";
        html =
          html +
          "<span>" +
          e.features[0].properties.description +
          "</span><br/>";
        html =
          html + "<span>" + e.features[0].properties.timestamp + "</span><br>";

        new mapboxgl.Popup().setLngLat(coordinates).setHTML(html).addTo(map);
      }
      function createLayerFilterOnIdleMap() {
        map.on("idle", function () {
          // If these two layers have been added to the style,
          // add the toggle buttons.
          if (map.getLayer("clusters") && map.getLayer("unclustered-point")) {
            // Enumerate ids of the layers.
            var toggleableLayerIds = ["clusters", "unclustered-point"];
            // Set up the corresponding toggle button for each layer.
            for (var i = 0; i < toggleableLayerIds.length; i++) {
              var id = toggleableLayerIds[i];
              if (!document.getElementById(id)) {
                // Create a link.
                var link = document.createElement("a");
                link.id = id;
                link.href = "#";
                link.textContent = id;
                link.className = "active";
                // Show or hide layer when the toggle is clicked.
                link.onclick = function (e) {
                  var clickedLayer = this.textContent;
                  e.preventDefault();
                  e.stopPropagation();

                  var visibility = map.getLayoutProperty(
                    clickedLayer,
                    "visibility"
                  );

                  // Toggle layer visibility by changing the layout object's visibility property.
                  if (visibility === "visible") {
                    map.setLayoutProperty(clickedLayer, "visibility", "none");
                    this.className = "";
                  } else {
                    this.className = "active";
                    map.setLayoutProperty(
                      clickedLayer,
                      "visibility",
                      "visible"
                    );
                  }
                };

                var layers = document.getElementById("menu");
                layers.appendChild(link);
              }
            }
          }
        });
      } /* } function end*/

      function hideLayers(layerNames) {
        if (layerNames !== undefined && layerNames.length > 0) {
          for (let i = 0; i < layerNames.length; i++) {
            let clickedLayer = layerNames[i];
            let visibility = map.getLayoutProperty(clickedLayer, "visibility");

            // Toggle layer visibility by changing the layout object's visibility property.
            if (visibility !== undefined && visibility === "visible") {
              map.setLayoutProperty(clickedLayer, "visibility", "none");
            }
          }
        }
      }

      function showLayers(layerNames) {
        if (layerNames !== undefined && layerNames.length > 0) {
          for (let i = 0; i < layerNames.length; i++) {
            let clickedLayer = layerNames[i];
            let visibility = map.getLayoutProperty(clickedLayer, "visibility");

            // Toggle layer visibility by changing the layout object's visibility property.
            if (visibility !== undefined && visibility === "none") {
              map.setLayoutProperty(clickedLayer, "visibility", "visible");
            }
          }
        }
      }

      function addImages(map, images) {
        const addImage = (map, id, url) => {
          return new Promise((resolve, reject) => {
            map.loadImage(url, (error, image) => {
              if (error) {
                reject(error);
                return;
              }
              map.addImage(id, image);
              resolve(image);
            });
          });
        };
        const promises = images.map((imageData) =>
          addImage(map, imageData.id, imageData.url)
        );
        return Promise.all(promises);
      }

      function addSourceAndLayersForAssetView() {
        // Add a new source from our GeoJSON data and
        // set the 'cluster' option to true. GL-JS will
        // add the point_count property to your source data.
        /* THE SOURCE LAYER FOR ASSET TRACKING DATA */
        map.addSource("asset-tracking-data", {
          type: "geojson",
          // Point to GeoJSON data. This example visualizes all M1.0+ asset-tracking-data
          // from 12/22/15 to 1/21/16 as logged by USGS' Earthquake hazards program.
          data: defaultGeoJsonForAssetView,
          //   "https://docs.mapbox.com/mapbox-gl-js/assets/asset-tracking-data.geojson",
          cluster: true,
          clusterMaxZoom: 14, // Max zoom to cluster points on
          clusterRadius: defaultClusterRadius, // Radius of each cluster when clustering points (defaults to 50)
          clusterProperties: {
            has_truck: ["any", ["==", ["get", "assetType"], "truck"], "false"],
            has_salesperson: [
              "any",
              ["==", ["get", "assetType"], "salesperson"],
              "false",
            ],
            only_truck: ["all", ["==", ["get", "assetType"], "truck"], "false"],
            only_salesperson: [
              "all",
              ["==", ["get", "assetType"], "salesperson"],
              "false",
            ],
            truck: ["+", ["case", truck, 1, 0]],
            salesperson: ["+", ["case", salesperson, 1, 0]],
            others: ["+", ["case", others, 1, 0]],
          },
        });

        map.addLayer({
          id: "clusters",
          type: "circle",
          source: "asset-tracking-data",
          filter: ["has", "point_count"],
          // layout: {
          //   "icon-image": [
          //     "case",
          //     ["all", ["get", "has_truck"], ["get", "has_salesperson"]],
          //     "truck+salesperson",
          //     ["get", "only_truck"],
          //     "truck",
          //     "salesperson",
          //   ],
          //   "icon-size": 0.06,
          //   "icon-allow-overlap": true,
          // },
          paint: {
            // Use step expressions (https://docs.mapbox.com/mapbox-gl-js/style-spec/#expressions-step)
            // with three steps to implement three types of circles:
            //   * Blue, 20px circles when point count is less than 100
            //   * Yellow, 30px circles when point count is between 100 and 750
            //   * Pink, 40px circles when point count is greater than or equal to 750
            "circle-color": [
              "step",
              ["get", "point_count"],
              "#51bbd6",
              100,
              "#f1f075",
              750,
              "#f28cb1",
            ],
            "circle-radius": [
              "step",
              ["get", "point_count"],
              20,
              100,
              30,
              750,
              40,
            ],
          },
          layout: {
            visibility: "none",
          },
        });

        map.addLayer({
          id: "cluster-count",
          type: "symbol",
          source: "asset-tracking-data",
          filter: ["has", "point_count"],
          layout: {
            "text-field": "{point_count_abbreviated}",
            "text-font": ["DIN Offc Pro Medium", "Arial Unicode MS Bold"],
            "text-size": 12,
            visibility: "none",
          },
        });

        map.addLayer({
          id: "unclustered-point",
          type: "symbol",
          source: "asset-tracking-data",
          filter: ["!", ["has", "point_count"]],
          layout: {
            "icon-image": [
              "coalesce",
              ["image", "custom-marker"],
              ["image", "rocket-15"],
            ],
            "icon-allow-overlap": true,
            "icon-size": 0.6,
            visibility: "none",
          },
        });

        // map.addLayer({
        //       id: "custom-image-layer",
        //       type: "symbol",
        //       source: "asset-tracking-data",
        //       filter: ["!", ["has", "point_count"]],
        //       layout: {
        //         "icon-image": "custom-marker",
        //         "icon-allow-overlap": true,
        //         "icon-size": 0.6,
        //         visibility: "visible",
        //       },
        //     });
      }

      function addSourceAndLayersForTimelineView() {
        addSourceAndLayerForRoute();
        addSourceAndLayerForAssetTimeLineView();
      }

      function addSourceAndLayerForRoute() {
        map.addSource("route-line-string", {
          type: "geojson",
          data: defaultLineString,
          // data: makeLineStringForGeoJsonTimelineView(timelineViewGeoJsonData),
          // <!-- #region data other forms -->
          // data: turf.lineString(
          //   makeLineStringForGeoJsonTimelineView(timelineViewGeoJsonData)
          //     .geometry.coordinates
          // ),
          // data with linestring data

          /*
          data: {
                    type: "Feature",
                    properties: {},
                    geometry: {
                      type: "LineString",
                      coordinates: [
                        [-122.48369693756104, 37.83381888486939],
                        [-122.48348236083984, 37.83317489144141],
                        [-122.48339653015138, 37.83270036637107],
                        [-122.48356819152832, 37.832056363179625],
                        [-122.48404026031496, 37.83114119107971],
                        [-122.48404026031496, 37.83049717427869],
                        [-122.48348236083984, 37.829920943955045],
                        [-122.48356819152832, 37.82954808664175],
                        [-122.48507022857666, 37.82944639795659],
                        [-122.48610019683838, 37.82880236636284],
                        [-122.48695850372314, 37.82931081282506],
                        [-122.48700141906738, 37.83080223556934],
                        [-122.48751640319824, 37.83168351665737],
                        [-122.48803138732912, 37.832158048267786],
                        [-122.48888969421387, 37.83297152392784],
                        [-122.48987674713133, 37.83263257682617],
                        [-122.49043464660643, 37.832937629287755],
                        [-122.49125003814696, 37.832429207817725],
                        [-122.49163627624512, 37.832564787218985],
                        [-122.49223709106445, 37.83337825839438],
                        [-122.49378204345702, 37.83368330777276],
                      ],
                    },
                  },

          <!-- #endregion -->
          */
        });
        map.addLayer({
          id: "route-line-string-view",
          type: "line",
          source: "route-line-string",
          layout: {
            "line-join": "round",
            "line-cap": "round",
            visibility: "none",
          },
          paint: {
            "line-color": "#888",
            // "line-color": "#f28cb1",
            // "line-color": "red",
            "line-width": 8,
          },
        });
      }

      function addSourceAndLayerForAssetTimeLineView() {
        map.addSource("timeline-view", {
          type: "geojson",
          // data: timelineViewGeoJsonData,
          data: defaultGeoJsonTimelineView,
        });

        map.addLayer({
          id: "timeline-view-point",
          type: "symbol",
          source: "timeline-view",
          filter: ["==", "$type", "Point"],
          layout: {
            // "icon-image": "custom-marker",
            "icon-image": [
              "coalesce",
              ["image", "custom-marker"],
              ["image", "rocket-15"],
            ],
            "icon-allow-overlap": true,
            "icon-size": 0.5,
            visibility: "none",
          },
        });

        map.addLayer({
          id: "timeline-view-polygon",
          type: "fill",
          source: "timeline-view",
          paint: {
            "fill-color": "#888888",
            "fill-opacity": 0.3,
          },
          filter: ["==", "$type", "Polygon"],
          layout: {
            visibility: "none",
          },
        });

        map.addLayer({
          id: "timeline-view-linestring-route",
          type: "line",
          source: "timeline-view",
          layout: {
            "line-join": "round",
            "line-cap": "round",
            visibility: "none",
          },
          paint: {
            "line-color": "#f28cb1",
            "line-width": 8,
          },
          filter: ["==", "$type", "LineString"],
        });
      }

      function showtimelineViewForAsset(timelineViewGeoJsonData) {
        makeLineLayerOnMap(timelineViewGeoJsonData);
      }

      function makeLineLayerOnMap(timelineViewGeoJsonData) {
        map.addSource("route-line-string", {
          type: "geojson",
          data: defaultLineString,
          // data: makeLineStringForGeoJsonTimelineView(timelineViewGeoJsonData),
          // <!-- #region data other forms -->
          // data: turf.lineString(
          //   makeLineStringForGeoJsonTimelineView(timelineViewGeoJsonData)
          //     .geometry.coordinates
          // ),
          // data with linestring data

          /*
          data: {
                    type: "Feature",
                    properties: {},
                    geometry: {
                      type: "LineString",
                      coordinates: [
                        [-122.48369693756104, 37.83381888486939],
                        [-122.48348236083984, 37.83317489144141],
                        [-122.48339653015138, 37.83270036637107],
                        [-122.48356819152832, 37.832056363179625],
                        [-122.48404026031496, 37.83114119107971],
                        [-122.48404026031496, 37.83049717427869],
                        [-122.48348236083984, 37.829920943955045],
                        [-122.48356819152832, 37.82954808664175],
                        [-122.48507022857666, 37.82944639795659],
                        [-122.48610019683838, 37.82880236636284],
                        [-122.48695850372314, 37.82931081282506],
                        [-122.48700141906738, 37.83080223556934],
                        [-122.48751640319824, 37.83168351665737],
                        [-122.48803138732912, 37.832158048267786],
                        [-122.48888969421387, 37.83297152392784],
                        [-122.48987674713133, 37.83263257682617],
                        [-122.49043464660643, 37.832937629287755],
                        [-122.49125003814696, 37.832429207817725],
                        [-122.49163627624512, 37.832564787218985],
                        [-122.49223709106445, 37.83337825839438],
                        [-122.49378204345702, 37.83368330777276],
                      ],
                    },
                  },

          <!-- #endregion -->
          */
        });
        map.addLayer({
          id: "route-line-string-view",
          type: "line",
          source: "route-line-string",
          layout: {
            "line-join": "round",
            "line-cap": "round",
            visibility: "none",
          },
          paint: {
            "line-color": "#888",
            // "line-color": "#f28cb1",
            // "line-color": "red",
            "line-width": 8,
          },
        });

        map.addSource("timeline-view", {
          type: "geojson",
          // data: timelineViewGeoJsonData,
          data: defaultGeoJsonTimelineView,
        });

        map.addLayer({
          id: "timeline-view-point",
          type: "symbol",
          source: "timeline-view",
          filter: ["==", "$type", "Point"],
          layout: {
            // "icon-image": "custom-marker",
            "icon-image": [
              "coalesce",
              ["image", "custom-marker"],
              ["image", "rocket-15"],
            ],
            "icon-allow-overlap": true,
            "icon-size": 0.5,
            visibility: "none",
          },
        });

        map.addLayer({
          id: "timeline-view-polygon",
          type: "fill",
          source: "timeline-view",
          paint: {
            "fill-color": "#888888",
            "fill-opacity": 0.3,
          },
          filter: ["==", "$type", "Polygon"],
          layout: {
            visibility: "none",
          },
        });

        map.addLayer({
          id: "timeline-view-linestring-route",
          type: "line",
          source: "timeline-view",
          layout: {
            "line-join": "round",
            "line-cap": "round",
            visibility: "none",
          },
          paint: {
            "line-color": "#f28cb1",
            "line-width": 8,
          },
          filter: ["==", "$type", "LineString"],
        });

        hideLayers(assetViewLayers);
        showLayers(timelineViewLayers);
        /* <!-- #region flyto -->

        map.flyTo({
          center: getCenterForTimeLineView(timelineViewGeoJsonData),
          essential: true, // this animation is considered essential with respect to prefers-reduced-motion
          zoom: 14,
          bearing: 0,

          // These options control the flight curve, making it move
          // slowly and zoom out almost completely before starting
          // to pan.
          speed: 0.8, // make the flying slow
          curve: 1, // change the speed at which it zooms out
        });

        <!-- #endregion --> */

        // map.fitBounds(turf.bbox(timelineViewGeoJsonData), { padding: 20 });
      }

      function makeLineStringForGeoJsonTimelineView(timelineViewGeoJsonData) {
        let features = timelineViewGeoJsonData.features;
        let lineStringCoordinates = [];
        for (let i = 0; i < features.length; i++) {
          if (features[i].geometry.type == "Point") {
            lineStringCoordinates.push(features[i].geometry.coordinates);
          }
        }
        let lineString = {
          type: "Feature",
          properties: {},
          geometry: {
            type: "LineString",
            coordinates: [lineStringCoordinates],
          },
        };
        return lineString;
      }

      function getCenterForTimeLineView(timelineViewGeoJsonData) {
        let len = timelineViewGeoJsonData.features.length;
        let mid = Math.floor(len / 2);
        return timelineViewGeoJsonData.features[mid].geometry.coordinates;
      }
    </script>
  </body>
</html>
